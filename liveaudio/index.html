<!doctype html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <title>HLS 音频流播放器</title>
        <script src="https://gcore.jsdelivr.net/npm/hls.js@latest"></script>
        <style>
            .player-container {
                margin: 20px;
                padding: 20px;
                border: 1px solid #ccc;
                max-width: 600px;
                margin: 20px auto;
            }
            #status {
                margin-top: 10px;
                color: #666;
                text-align: center;
            }
            .controls {
                margin-top: 10px;
                text-align: center;
            }
            audio {
                width: 100%;
                margin: 10px 0;
            }
            button {
                padding: 10px 20px;
                margin: 0 5px;
                background-color: #4caf50;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }
            button:hover {
                background-color: #45a049;
            }
            button:active {
                background-color: #3d8b40;
            }
        </style>
    </head>
    <body>
        <div class="player-container">
            <audio id="audio" controls></audio>
            <div id="status">等待连接...</div>
            <div class="controls">
                <button onclick="startStream()">开始推流</button>
                <button onclick="stopStream()">停止推流</button>
            </div>
        </div>

        <script>
            // 配置服务器地址
            const SERVER_URL = "http://ip.chunzha.tech:1935";
            const audio = document.getElementById("audio");
            const status = document.getElementById("status");
            const streamUrl = `${SERVER_URL}/static/stream.m3u8`;
            let hls = null;

            function initPlayer() {
                if (hls) {
                    hls.destroy();
                }

                if (Hls.isSupported()) {
                    hls = new Hls({
                        debug: false,
                        manifestLoadingTimeOut: 20000,
                        manifestLoadingMaxRetry: 3,
                        manifestLoadingRetryDelay: 500,
                        levelLoadingTimeOut: 20000,
                        levelLoadingMaxRetry: 3,
                        levelLoadingRetryDelay: 500,
                    });

                    hls.attachMedia(audio);

                    hls.on(Hls.Events.MEDIA_ATTACHED, function () {
                        status.textContent = "媒体附加成功，加载流...";
                        hls.loadSource(streamUrl);
                    });

                    hls.on(Hls.Events.MANIFEST_PARSED, function () {
                        status.textContent = "清单解析完成，开始播放...";
                        audio.play().catch(function (error) {
                            status.textContent = "播放失败: " + error.message;
                        });
                    });

                    hls.on(Hls.Events.ERROR, function (event, data) {
                        if (data.fatal) {
                            switch (data.type) {
                                case Hls.ErrorTypes.NETWORK_ERROR:
                                    status.textContent =
                                        "网络错误，尝试恢复...";
                                    hls.startLoad();
                                    break;
                                case Hls.ErrorTypes.MEDIA_ERROR:
                                    status.textContent =
                                        "媒体错误，尝试恢复...";
                                    hls.recoverMediaError();
                                    break;
                                default:
                                    status.textContent =
                                        "发生致命错误: " + data.type;
                                    hls.destroy();
                                    break;
                            }
                        }
                    });
                } else if (audio.canPlayType("application/vnd.apple.mpegurl")) {
                    // 对于原生支持 HLS 的浏览器（如 Safari）
                    audio.src = streamUrl;
                    audio.addEventListener("loadedmetadata", function () {
                        status.textContent = "使用原生 HLS 播放...";
                        audio.play().catch(function (error) {
                            status.textContent = "播放失败: " + error.message;
                        });
                    });
                } else {
                    // 不支持 HLS 的浏览器
                    status.textContent = "您的浏览器不支持 HLS";
                }
            }

            async function startStream() {
                try {
                    const response = await fetch(
                        `${SERVER_URL}/api/stream/start`,
                    );
                    const data = await response.json();
                    if (data.status === "success") {
                        status.textContent = "正在启动流...";
                        setTimeout(initPlayer, 2000); // 给FFmpeg一些启动时间
                    } else {
                        status.textContent = data.message;
                    }
                } catch (error) {
                    status.textContent = "启动流失败: " + error;
                }
            }

            async function stopStream() {
                try {
                    const response = await fetch(
                        `${SERVER_URL}/api/stream/stop`,
                    );
                    const data = await response.json();
                    if (data.status === "success") {
                        status.textContent = "流已停止";
                        if (hls) {
                            hls.destroy();
                            hls = null;
                        }
                        audio.src = "";
                    } else {
                        status.textContent = data.message;
                    }
                } catch (error) {
                    status.textContent = "停止流失败: " + error;
                }
            }

            // 自动检查流状态
            async function checkStreamStatus() {
                try {
                    const response = await fetch(
                        `${SERVER_URL}/api/stream/status`,
                    );
                    const data = await response.json();
                    if (data.status === "active" && !hls) {
                        initPlayer();
                    }
                } catch (error) {
                    console.error("检查流状态失败:", error);
                }
            }

            // 定期检查流状态
            setInterval(checkStreamStatus, 5000);

            // 监听播放状态
            audio.addEventListener("playing", () => {
                status.textContent = "正在播放";
            });

            audio.addEventListener("waiting", () => {
                status.textContent = "缓冲中...";
            });

            audio.addEventListener("error", () => {
                status.textContent =
                    "播放错误: " +
                    (audio.error ? audio.error.message : "未知错误");
            });

            // 页面加载完成后检查流状态
            window.addEventListener("load", checkStreamStatus);
        </script>
    </body>
</html>
